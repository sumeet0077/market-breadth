name: Daily Data Update

on:
  schedule:
    # Run at 19:30 IST (14:00 UTC)
    - cron: '0 14 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-data:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Python Dependencies
        run: |
          pip install -r requirements.txt

      - name: Run Data Pipeline
        run: |
          # 1. Fetch Data
          python scripts/fetch_data.py
          # 2. Process Data
          python scripts/process_data.py
          # 3. Calculate Metrics
          python scripts/calculate_metrics.py
          
          # 4. Move JSON to Web Public folder (Crucial for Next.js)
          cp data/market_breadth.json web/public/market_breadth.json

      - name: Commit and Push Changes (Failsafe)
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # Check if there are changes
          if [[ -z $(git status -s) ]]; then
            echo "‚úÖ No changes to commit. Data is already up-to-date."
            exit 0
          fi
          
          git add data/ web/public/market_breadth.json
          git commit -m "üìà Auto-update: Market Breadth Data [skip ci]"
          
          # Robust Push with Retry Logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Push attempt $((RETRY_COUNT + 1)) of $MAX_RETRIES..."
            
            # Fetch latest changes
            git fetch origin main
            
            # Check if we are behind remote
            LOCAL=$(git rev-parse HEAD)
            REMOTE=$(git rev-parse origin/main)
            
            if [ "$LOCAL" != "$REMOTE" ]; then
              echo "‚ö†Ô∏è Local is behind remote. Rebasing..."
              git rebase origin/main || {
                echo "‚ö†Ô∏è Rebase conflict. Aborting rebase and forcing data update..."
                git rebase --abort
                # Keep our data (theirs is older)
                git checkout --ours data/market_breadth.json web/public/market_breadth.json
                git add data/market_breadth.json web/public/market_breadth.json
                git commit -m "üìà Auto-update: Market Breadth Data (Conflict Resolved) [skip ci]"
              }
            fi
            
            # Attempt push
            if git push; then
              echo "‚úÖ Push successful!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Push failed. Retrying in 5 seconds..."
            sleep 5
          done
          
          echo "‚ùå Failed to push after $MAX_RETRIES attempts."
          exit 1
